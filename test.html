<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Confessions with Replies</title>
  <style>
    body { font-family: Arial, sans-serif; background:#f9f9f9; margin:0; padding:20px; }
    .confession-card {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .card-header { display:flex; align-items:center; margin-bottom:10px; }
    .card-pic { width:40px; height:40px; border-radius:50%; margin-right:10px; }
    .card-name { font-weight:bold; }
    .confession-message { margin:10px 0; font-size:15px; }
    .reply-section { margin-top:10px; padding-left:20px; border-left:2px solid #eee; }
    .reply-card { display:flex; align-items:flex-start; margin-bottom:8px; }
    .reply-card img { width:28px; height:28px; border-radius:50%; margin-right:8px; }
    .reply-card .reply-content { background:#f2f2f2; padding:6px 10px; border-radius:8px; font-size:14px; }
    .reply-input { display:flex; margin-top:8px; }
    .reply-input input {
      flex:1; padding:6px; border:1px solid #ccc; border-radius:6px; margin-right:5px;
    }
    .reply-input button {
      padding:6px 12px; border:none; border-radius:6px;
      background:#4a90e2; color:white; cursor:pointer;
    }
  </style>
</head>
<body>
  <h2>Confessions</h2>
  <div id="confession-list"></div>

  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script>
    // Supabase init
    const client = supabase.createClient(
      "https://fuovcuzaxfkyqrridrgy.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZ1b3ZjdXpheGZreXFycmlkcmd5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU0NzIyMjAsImV4cCI6MjA2MTA0ODIyMH0._PkkfWXcn4j6cjBh-yLJjDevrmhuxKxVbcdQUSgCsSk"
    );

    // Get cookie helper
    function getCookie(name) {
      let match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
      return match ? match[2] : null;
    }

    // Fetch confessions
    async function fetchConfessions() {
      const { data, error } = await client.from("confessions").select("*").order("roll", { ascending: false });
      if (error) { console.error(error); return; }

      const list = document.getElementById("confession-list");
      list.innerHTML = "";

      data.forEach(conf => {
        list.insertAdjacentHTML("beforeend", `
          <div class="confession-card" id="conf-${conf.roll}">
            <div class="card-header">
              <img src="${conf.pic}" class="card-pic">
              <div class="card-name">${conf.c_name}</div>
            </div>
            <p class="confession-message">${conf.confess}</p>

            <div class="reply-section" id="replies-${conf.roll}"></div>

            <div class="reply-input">
              <input type="text" id="replyInput-${conf.roll}" placeholder="Write a reply..."/>
              <button onclick="addReply(${conf.roll})">Reply</button>
            </div>
          </div>
        `);

        // load replies for this confession
        fetchReplies(conf.roll);
      });
    }

    // Fetch replies
    async function fetchReplies(confessionId) {
      const { data, error } = await client
        .from("replies")
        .select("*")
        .eq("confession_id", confessionId)
        .order("created_at", { ascending: true });

      if (error) { console.error(error); return; }

      const repliesDiv = document.getElementById(`replies-${confessionId}`);
      repliesDiv.innerHTML = "";

      data.forEach(reply => {
        repliesDiv.insertAdjacentHTML("beforeend", `
          <div class="reply-card">
            <img src="${reply.reply_pic || "https://via.placeholder.com/28"}">
            <div class="reply-content">
              <strong>${reply.replier_name}</strong><br>
              ${reply.reply_message}
            </div>
          </div>
        `);
      });
    }

    // Add reply
    async function addReply(confessionId) {
      const roll = getCookie("roll");
      if (!roll) { alert("Not logged in!"); return; }

      const input = document.getElementById(`replyInput-${confessionId}`);
      const replyMessage = input.value.trim();
      if (!replyMessage) return;

      // Get replier info from BAF table
      const { data: userData, error: userError } = await client
        .from("BAF")
        .select("NAME, img")
        .eq("ROLL", roll)
        .single();

      if (userError || !userData) { alert("User not found"); return; }

      const { error } = await client.from("replies").insert([{
        confession_id: confessionId,
        reply_message: replyMessage,
        replier_name: userData.NAME,
        reply_pic: userData.img
      }]);

      if (error) {
        console.error(error);
        alert("Failed to reply");
      } else {
        input.value = "";
        fetchReplies(confessionId);
      }
    }

    fetchConfessions();
  </script>
</body>
</html>
