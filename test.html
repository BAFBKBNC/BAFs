<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Confessions</title>
  <style>
    :root {
      --primary-gradient: linear-gradient(135deg, #4a90e2, #243b8f);
      --card-bg: #ffffff;
      --card-bg-dark: #1e1e1e;
      --border-color: #ddd;
      --border-color-dark: #444;
      --text-color: #222;
      --text-color-dark: #eee;
    }

    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 15px;
      background: #f4f6fa;
      color: var(--text-color);
    }

    body.dark {
      background: #121212;
      color: var(--text-color-dark);
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
      font-size: 22px;
    }

    .confession-card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 15px;
      margin-bottom: 18px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      transition: background 0.3s, border-color 0.3s;
    }

    body.dark .confession-card {
      background: var(--card-bg-dark);
      border-color: var(--border-color-dark);
    }

    .card-header {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .card-pic {
      width: 42px;
      height: 42px;
      border-radius: 50%;
      margin-right: 10px;
      border: 2px solid #ccc;
    }

    .card-name {
      font-weight: 600;
      font-size: 15px;
    }

    .confession-message {
      margin: 12px 0;
      font-size: 15px;
      line-height: 1.4;
      white-space: pre-wrap;
    }

    /* Replies */
    .reply-section {
      margin-top: 10px;
      padding-left: 15px;
      border-left: 2px solid var(--border-color);
    }

    body.dark .reply-section {
      border-color: var(--border-color-dark);
    }

    .reply-card {
      display: flex;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .reply-card img {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      margin-right: 8px;
    }

    .reply-card .reply-content {
      background: #f2f2f2;
      padding: 6px 10px;
      border-radius: 10px;
      font-size: 14px;
      max-width: 80%;
      word-wrap: break-word;
    }

    body.dark .reply-card .reply-content {
      background: #2a2a2a;
    }

    .reply-input {
      display: flex;
      margin-top: 10px;
      gap: 6px;
    }

    .reply-input input {
      flex: 1;
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      font-size: 14px;
    }

    body.dark .reply-input input {
      background: #1e1e1e;
      color: var(--text-color-dark);
      border-color: var(--border-color-dark);
    }

    .reply-input button {
      padding: 8px 14px;
      border: none;
      border-radius: 8px;
      background: var(--primary-gradient);
      color: white;
      font-size: 14px;
      cursor: pointer;
    }

    .reply-input button:active {
      opacity: 0.85;
    }

    /* Mobile */
    @media (max-width: 600px) {
      body { padding: 10px; }
      .confession-card { padding: 12px; }
      .card-pic { width: 36px; height: 36px; }
      .confession-message { font-size: 14px; }
      .reply-card .reply-content { font-size: 13px; }
      .reply-input input { font-size: 13px; }
    }
  </style>
</head>
<body>
  <h2>Confessions</h2>
  <div id="confession-list"></div>

  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <script>
    // Supabase init
    const client = supabase.createClient(
      "https://YOUR-PROJECT-REF.supabase.co",
      "YOUR-ANON-KEY"
    );

    // Get cookie helper
    function getCookie(name) {
      let match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
      return match ? match[2] : null;
    }

    // Fetch confessions
    async function fetchConfessions() {
      const { data, error } = await client
        .from("confessions")
        .select("*")
        .order("roll", { ascending: false });

      if (error) { console.error(error); return; }

      const list = document.getElementById("confession-list");
      list.innerHTML = "";

      data.forEach(conf => {
        list.insertAdjacentHTML("beforeend", `
          <div class="confession-card" id="conf-${conf.roll}">
            <div class="card-header">
              <img src="${conf.pic}" class="card-pic">
              <div class="card-name">${conf.c_name}</div>
            </div>
            <p class="confession-message">${conf.confess}</p>

            <div class="reply-section" id="replies-${conf.roll}"></div>

            <div class="reply-input">
              <input type="text" id="replyInput-${conf.roll}" placeholder="Write a reply..."/>
              <button onclick="addReply(${conf.roll})">Reply</button>
            </div>
          </div>
        `);

        fetchReplies(conf.roll);
      });
    }

    // Fetch replies
    async function fetchReplies(confessionId) {
      const { data, error } = await client
        .from("replies")
        .select("*")
        .eq("confession_id", confessionId)
        .order("created_at", { ascending: true });

      if (error) { console.error(error); return; }

      const repliesDiv = document.getElementById(`replies-${confessionId}`);
      repliesDiv.innerHTML = "";

      data.forEach(reply => {
        repliesDiv.insertAdjacentHTML("beforeend", `
          <div class="reply-card">
            <img src="${reply.reply_pic || "https://via.placeholder.com/28"}">
            <div class="reply-content">
              <strong>${reply.replier_name}</strong><br>
              ${reply.reply_message}
            </div>
          </div>
        `);
      });
    }

    // Add reply
    async function addReply(confessionId) {
      const roll = getCookie("roll");
      if (!roll) { alert("Not logged in!"); return; }

      const input = document.getElementById(`replyInput-${confessionId}`);
      const replyMessage = input.value.trim();
      if (!replyMessage) return;

      // Get replier info from BAF table
      const { data: userData, error: userError } = await client
        .from("BAF")
        .select("NAME, img")
        .eq("ROLL", roll)
        .single();

      if (userError || !userData) { alert("User not found"); return; }

      const { error } = await client.from("replies").insert([{
        confession_id: confessionId,
        reply_message: replyMessage,
        replier_name: userData.NAME,
        reply_pic: userData.img
      }]);

      if (error) {
        console.error(error);
        alert("Failed to reply");
      } else {
        input.value = "";
        fetchReplies(confessionId);
      }
    }

    fetchConfessions();
  </script>
</body>
</html>
